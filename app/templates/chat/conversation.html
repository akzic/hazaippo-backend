{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/conversation.css') }}">
<style>
/* モーダル表示用のスタイル */
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0,0,0,0.8);
}
.modal-content {
  margin: 5% auto;
  display: block;
  max-width: 80%;
}
.close {
  position: absolute;
  top: 15px;
  right: 35px;
  color: #fff;
  font-size: 40px;
  font-weight: bold;
  cursor: pointer;
}
</style>
{% endblock %}

{% block content %}
<div class="container mt-4" data-conversation-id="{{ conversation.id }}">
    <h2>会話: {{ other_user.company_name }} {{ other_user.contact_name }} 様</h2>
    
    <div class="conversation-box border p-3 mb-4" style="height: 400px; overflow-y: scroll;">
        {% for msg in messages %}
            <div class="message mb-2 {% if msg.sender_id == current_user.id %}text-right{% else %}text-left{% endif %}">
                <div class="message-content d-inline-block p-2 rounded {{ 'message-sender' if msg.sender_id == current_user.id else 'message-receiver' }}">
                    <strong>{{ msg.sender.company_name }}{{ msg.sender.contact_name }}</strong><br>
                    {% if msg.content %}
                      <span>{{ msg.content }}</span><br>
                    {% endif %}
                    {% if msg.attachment %}
                      <img src="{{ msg.attachment }}" class="message-image" style="max-width:200px; cursor:pointer;">
                    {% endif %}
                    <small class="text-muted">{{ msg.timestamp|format_datetime_jst }}</small>
                </div>
            </div>
        {% else %}
            <p class="text-center text-muted">まだメッセージはありません。</p>
        {% endfor %}
    </div>

    <form id="messageForm" action="{{ url_for('chat.conversation_view', conversation_id=conversation.id) }}" method="post">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="attachment" id="attachmentInput" value="">
        <div class="form-group">
            <textarea name="message" class="form-control" rows="3" placeholder="メッセージを入力"></textarea>
        </div>
        <button type="submit" class="btn btn-primary">送信</button>
    </form>
    
    <div class="image-upload mt-3">
        <button id="uploadImageButton" class="btn btn-secondary">画像送信</button>
        <input type="file" id="imageInput" accept=".png,.jpg,.jpeg,.gif,.heic" style="display: none;">
    </div>
    
    <div class="mt-3">
        <a href="{{ url_for('dashboard.dashboard_home') }}" class="btn btn-back">戻る</a>
    </div>
</div>

<!-- モーダル表示用 -->
<div id="imageModal" class="modal">
    <span class="close">&times;</span>
    <img class="modal-content" id="modalImage">
</div>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script>
$(document).ready(function() {
    // ページロード時に会話ボックスの最下部へスクロール
    var $convBox = $('.conversation-box');
    if($convBox.length) {
        $convBox.scrollTop($convBox[0].scrollHeight);
    }

    // 画像送信ボタン押下でファイル選択をトリガー
    $('#uploadImageButton').click(function() {
        $('#imageInput').click();
    });

    // ファイル選択時の処理
    $('#imageInput').change(function() {
        var file = this.files[0];
        if (!file) return;
        var allowedExtensions = ['png', 'jpg', 'jpeg', 'gif', 'heic'];
        var fileExtension = file.name.split('.').pop().toLowerCase();
        if (allowedExtensions.indexOf(fileExtension) === -1) {
            alert('許可されていないファイル形式です。許可されている形式: ' + allowedExtensions.join(', '));
            $(this).val('');
            return;
        }
        var maxSize = 5 * 1024 * 1024; // 5MB
        if (file.size > maxSize) {
            alert('アップロードできるファイルサイズは5MBまでです。');
            $(this).val('');
            return;
        }
        var formData = new FormData();
        // CSRF トークンを追加（hidden input の値を使用）
        formData.append('csrf_token', $('input[name=csrf_token]').val());
        formData.append('file', file);
        // Ajax によるファイルアップロード
        $.ajax({
            url: "{{ url_for('chat.upload_file') }}",
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                // アップロード成功後、hidden フィールドに URL をセットしフォーム送信
                $('#attachmentInput').val(response.file_url);
                $('#messageForm').submit();
            },
            error: function(xhr) {
                alert(xhr.responseJSON.error || '画像のアップロード中にエラーが発生しました。');
            }
        });
    });
    
    // 送信済み画像をクリックしたらモーダルで表示
    $(document).on('click', '.message-image', function() {
        var src = $(this).attr('src');
        $('#modalImage').attr('src', src);
        $('#imageModal').fadeIn();
    });
    
    // モーダルエリアまたは閉じるボタンをクリックでモーダルを閉じる
    $('#imageModal, #imageModal .close').on('click', function() {
        $('#imageModal').fadeOut();
    });
});
</script>
{% endblock %}
